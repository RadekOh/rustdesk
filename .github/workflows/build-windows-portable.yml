name: Build RustDesk Windows Portable (Flutter)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      VCPKG_DEFAULT_HOST_TRIPLET: x64-windows
      VCPKG_CMAKE_GENERATOR: Visual Studio 17 2022
      VCPKG_DISABLE_METRICS: "1"

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Flutter Windows Desktop
        shell: pwsh
        run: |
          flutter config --enable-windows-desktop
          flutter doctor -v

      - name: Setup LLVM/Clang (for bindgen)
        shell: pwsh
        run: |
          $llvmBin = "C:\Program Files\LLVM\bin"
          if (Test-Path $llvmBin) {
            "LIBCLANG_PATH=$llvmBin" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "Using preinstalled LLVM at $llvmBin"
          } else {
            choco install -y llvm
            "LIBCLANG_PATH=$llvmBin" | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Install vcpkg deps (manifest) + force MSBuild generator
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:USERPROFILE\vcpkg
          & $env:USERPROFILE\vcpkg\bootstrap-vcpkg.bat

          # Nastav VCPKG_ROOT hned v aktuálním stepu + i pro další stepy
          $env:VCPKG_ROOT = "$env:USERPROFILE\vcpkg"
          "VCPKG_ROOT=$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append

          # Manifest mode: repo má vcpkg.json => instalace bez vyjmenování balíčků
          & $env:VCPKG_ROOT\vcpkg.exe install `
          --x-manifest-root "$env:GITHUB_WORKSPACE" `
          --vcpkg-root "$env:VCPKG_ROOT" `
          --triplet x64-windows-static `
          --host-triplet x64-windows

      - name: Show aom config error log (if exists)
        if: failure()
        shell: pwsh
        run: |
          $p = "C:\Users\runneradmin\vcpkg\buildtrees\aom\config-x64-windows-dbg-err.log"
          if (Test-Path $p) {
            Write-Host "=== Tail of $p ==="
            Get-Content $p -Tail 200
          } else {
            Write-Host "No aom err log found at $p"
          }
          
      - name: Flutter pub get
        shell: pwsh
        run: |
          cd flutter
          flutter pub get
          cd ..

      - name: Build portable EXE
        shell: pwsh
        run: |
          python build.py --flutter --portable

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-portable
          path: |
            rustdesk-*-install.exe

      - name: Upload vcpkg buildtrees logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-buildtrees-logs
          path: |
            C:\Users\runneradmin\vcpkg\buildtrees\

      - name: Upload project vcpkg_installed (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-installed-tree
          path: |
            D:\a\rustdesk\rustdesk\vcpkg_installed\
