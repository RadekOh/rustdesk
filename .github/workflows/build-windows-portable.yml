name: Build RustDesk Windows Portable (Flutter)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Enable Flutter Windows Desktop
        shell: pwsh
        run: |
          flutter config --enable-windows-desktop
          flutter doctor -v

      - name: Setup LLVM/Clang (for bindgen)
        shell: pwsh
        run: |
          $llvmBin = "C:\Program Files\LLVM\bin"
          if (Test-Path $llvmBin) {
            "LIBCLANG_PATH=$llvmBin" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "Using preinstalled LLVM at $llvmBin"
          } else {
            choco install -y llvm
            "LIBCLANG_PATH=$llvmBin" | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Install vcpkg deps (manifest) + force MSBuild generator
        shell: pwsh
        run: |
          # 1) Clone + bootstrap vcpkg
          git clone https://github.com/microsoft/vcpkg $env:USERPROFILE\vcpkg
          & $env:USERPROFILE\vcpkg\bootstrap-vcpkg.bat
      
          # 2) Okamžitě nastav VCPKG_ROOT v aktuálním stepu (ne až přes GITHUB_ENV)
          $env:VCPKG_ROOT = "$env:USERPROFILE\vcpkg"
          "VCPKG_ROOT=$env:VCPKG_ROOT" | Out-File -FilePath $env:GITHUB_ENV -Append
      
          # 3) Workaround na ninja.exe -v problém: donuť generator na Visual Studio (MSBuild)
          $env:VCPKG_CMAKE_GENERATOR = "Visual Studio 17 2022"
          "VCPKG_CMAKE_GENERATOR=$env:VCPKG_CMAKE_GENERATOR" | Out-File -FilePath $env:GITHUB_ENV -Append
      
          # 4) Manifest mode: v repu je vcpkg.json => instalace bez argumentů.
          #    (Ukotvíme manifest root a vcpkg root explicitně.)
          & $env:VCPKG_ROOT\vcpkg.exe install `
            --x-manifest-root "$env:GITHUB_WORKSPACE" `
            --vcpkg-root "$env:VCPKG_ROOT" `
            --triplet x64-windows-static
      
      - name: Flutter pub get
        shell: pwsh
        run: |
          cd flutter
          flutter pub get
          cd ..

      - name: Build portable EXE
        shell: pwsh
        run: |
          python build.py --flutter --portable

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-portable
          path: |
            rustdesk-*-install.exe
